{"version":3,"file":"half-screen.js","sources":["pages/template/half-screen/half-screen.uvue","../../../Program Files/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXNcdGVtcGxhdGVcaGFsZi1zY3JlZW5caGFsZi1zY3JlZW4udXZ1ZQ"],"sourcesContent":["<template>\r\n  <view ref=\"page\" class=\"page\">\r\n    <text class=\"tip\">半屏弹窗，演示了弹出层内scroll-view滚动到顶时由滚变拖。本效果是通过监听TouchEvent实现，当半屏窗口移动时禁用scroll-view的滚动，避免两者的冲突。</text>\r\n    <button class=\"bottomButton\" @click=\"switchHalfScreen(true)\">打开弹窗</button>\r\n    <view ref=\"halfScreen\" class=\"halfScreen\" @touchstart=\"onHalfTouchStart\" @touchmove=\"onHalfTouchMove\"\r\n      @touchend=\"onHalfTouchEnd\">\r\n      <view class=\"halfTitle\">半屏弹窗标题</view>\r\n      <scroll-view ref=\"halfScroll\" class=\"halfScroll\" bounces=\"true\" :direction=\"scrollDirection\">\r\n        <view v-for=\"(item,index) in list\" :key=\"index\" class=\"item\">\r\n          half screen content-{{item}}\r\n        </view>\r\n      </scroll-view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script lang=\"uts\">\r\n  export default {\r\n    data() {\r\n      return {\r\n        list: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15'],\r\n        totalHeight: 0,\t\t//总高度\r\n        halfMove: false,\t//是否Move，响应TouchMove\r\n        halfScreenY: 0,\t\t//响应TouchMove的起始点Y坐标\r\n        halfOffset: 0,\t\t//偏移的位置，translateY\r\n        halfHeight: 0,\t\t//高度\r\n        lastY: 0,\t\t\t//上次\r\n        lastY2: 0,\t\t\t//\r\n        bAnimation: false,\t//是否动画\r\n        halfNode: null as UniElement | null,\r\n        scrollNode: null as UniElement | null,\r\n        scrollDirection: 'vertical'\r\n      }\r\n    },\r\n    methods: {\r\n      onHalfTouchStart(_ : TouchEvent) {\r\n        this.halfNode?.style?.setProperty('transition-duration', 0);\r\n      },\r\n      onHalfTouchMove(e : TouchEvent) {\r\n        if (this.bAnimation) {//容错处理\r\n          return;\r\n        }\r\n        let top : number = this.scrollNode?.scrollTop ?? 0;\r\n        let p = e.touches[0];\r\n        this.lastY2 = this.lastY;\r\n        this.lastY = p.screenY;\r\n        if (top <= 0.01 || this.halfMove) {\r\n          if (this.halfScreenY == 0) {\r\n            this.halfScreenY = p.screenY;\r\n          }\r\n          let offset = p.screenY - this.halfScreenY;\r\n          if (offset > 0) {//向下滚动\r\n            this.halfMove = true;\r\n\r\n\r\n\r\n\r\n\r\n            this.scrollDirection = 'none';\r\n\r\n            this.halfNode?.style?.setProperty('transform', 'translateY(' + offset.toFixed(2) + 'px)');\r\n            this.halfOffset = offset;\r\n          } else if (this.halfOffset > 0) {//向上滚动\r\n            offset = this.halfScreenY - p.screenY;\r\n            if (offset > this.halfOffset) {\r\n              offset = 0;\r\n              this.halfMove = false;\r\n            }\r\n\r\n\r\n\r\n\r\n\r\n            this.scrollDirection = 'vertical';\r\n\r\n            this.halfNode?.style?.setProperty('transform', 'translateY(' + offset.toFixed(2) + 'px)');\r\n            this.halfOffset = offset;\r\n          }\r\n        }\r\n\r\n\r\n\r\n      },\r\n      onHalfTouchEnd(_ : TouchEvent) {\r\n        this.halfScreenY = 0;\r\n        if (this.bAnimation) {//容错处理\r\n          return;\r\n        }\r\n        let top : number = this.scrollNode?.scrollTop ?? 0;\r\n        let bHide = (this.halfHeight - this.halfOffset) < this.halfHeight / 4;\r\n        if (bHide) {\r\n          bHide = this.lastY2 > 0 && this.lastY2 <= this.lastY;\r\n        } else if (top <= 0.01) {\r\n          bHide = (this.lastY - this.lastY2) > 3;\t\t//向下滑动计算加速度判断是否关闭，简单处理未考虑时间\r\n        }\r\n        if (bHide) {\r\n          this.switchHalfScreen(false);\r\n        } else if (this.halfOffset > 0) {\r\n          this.resumeHalfScreen();\r\n        }\r\n      },\r\n      switchHalfScreen(show : boolean) {\r\n        if (show && ('visible' == this.halfNode?.style?.getPropertyValue('visibility'))) {//容错处理\r\n          uni.__f__('log','at pages/template/half-screen/half-screen.uvue:104','quick click button!!!');\r\n          return;\r\n        }\r\n        this.halfMove = false;\r\n\r\n\r\n\r\n\r\n\r\n        this.scrollDirection = 'vertical';\r\n\r\n        this.halfScreenY = 0;\r\n        this.halfOffset = 0;\r\n        let top = this.totalHeight;\r\n        let time = 300;\r\n        if (show) {\r\n          top = this.totalHeight * 30 / 100;\t//计算显示的位置\r\n          this.halfNode?.style?.setProperty('visibility', 'visible');\r\n          this.halfNode?.style?.setProperty('transition-timing-function', 'ease-in-out');\r\n        } else {\r\n          this.halfNode?.style?.setProperty('transition-timing-function', 'linear');\r\n          time *= (this.halfHeight / this.totalHeight);\t\t//计算关闭动画时间\r\n        }\r\n        this.halfNode?.style?.setProperty('transition-duration', time.toFixed(0)+'ms');\r\n        this.halfNode?.style?.setProperty('transition-property', 'top');\r\n        this.halfNode?.style?.setProperty('top', top.toFixed(2)+'px');\r\n        setTimeout(() => {\r\n          if (!show) {\r\n            this.halfNode?.style?.setProperty('visibility', 'hidden');\r\n            this.halfNode?.style?.setProperty('transition-duration', 0);\r\n            this.halfNode?.style?.setProperty('transform', '');\r\n          }\r\n          this.halfNode?.style?.setProperty('transition-property', 'none');\r\n          this.bAnimation = false;\r\n        }, time)\r\n        this.bAnimation = true;\r\n      },\r\n      resumeHalfScreen() {\r\n        let time = 300;//(500*this.halfOffset/this.halfHeight).toFixed(0); //回弹动画时间\r\n        this.halfNode?.style?.setProperty('transition-duration', time.toFixed(0)+'ms');\r\n        this.halfNode?.style?.setProperty('transition-timing-function', 'ease-in-out');\r\n        this.halfNode?.style?.setProperty('transition-property', 'transform');\r\n        this.halfNode?.style?.setProperty('transform', 'translateY(0px)');\r\n        this.halfMove = false;\r\n\r\n\r\n\r\n\r\n\r\n        this.scrollDirection = 'vertical';\r\n\r\n        this.halfScreenY = 0;\r\n        this.halfOffset = 0;\r\n        setTimeout(() => {\r\n          this.bAnimation = false;\r\n          this.halfNode?.style?.setProperty('transition-property', 'none');\r\n        }, time)\r\n        this.bAnimation = true;\r\n      }\r\n    },\r\n    onReady() {\r\n      this.halfNode = this.$refs['halfScreen'] as UniElement;//uni.getElementById('halfScreen');\r\n      this.scrollNode = this.$refs['halfScroll'] as UniElement;//uni.getElementById('halfScroll');\r\n      this.halfNode!.getBoundingClientRectAsync()!.then((rect: DOMRect) => {\r\n          this.halfHeight = rect.height\r\n      });\r\n      (this.$refs['page'] as UniElement).getBoundingClientRectAsync()!.then((rect: DOMRect) => {\r\n          this.totalHeight = rect.height\r\n          this.halfNode?.style?.setProperty('top', this.totalHeight.toFixed(2)+'px');\r\n      });\r\n    },\r\n    onResize() {\r\n      this.halfNode?.getBoundingClientRectAsync()!.then((rect: DOMRect) => {\r\n          this.halfHeight = rect.height\r\n      });\r\n      this.totalHeight = uni.getWindowInfo().windowHeight;\r\n      this.halfNode?.style?.setProperty('top', this.totalHeight.toFixed(2)+'px');\r\n      this.halfNode?.style?.setProperty('visibility', 'hidden');\r\n    },\r\n    onBackPress(): boolean {\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n    }\r\n  }\r\n</script>\r\n\r\n<style>\r\n\r\n  page {\r\n    overflow: hidden\r\n  }\r\n\r\n\r\n  .page {\r\n    flex: 1;\r\n    background-color: darkgrey;\r\n  }\r\n\r\n  .tip {\r\n    margin: 10px\r\n  }\r\n\r\n  .bottomButton {\r\n    position: absolute;\r\n    width: 100%;\r\n    bottom: 0px;\r\n\r\n\r\n\r\n  }\r\n\r\n  .halfScreen {\r\n    position: absolute;\r\n    top: 100%;\r\n    width: 100%;\r\n    height: 70%;\r\n    transition-timing-function: ease-in-out;\r\n    /*ease ease-in ease-out ease-in-out linear step-start step-end*/\r\n    transition-property: top;\r\n    transition-duration: 0ms;\r\n    visibility: hidden;\r\n  }\r\n\r\n  .halfTitle {\r\n    align-items: center;\r\n    justify-content: center;\r\n    height: 48px;\r\n    background-color: ghostwhite;\r\n    border-radius: 10px 10px 0 0;\r\n  }\r\n\r\n  .halfScroll {\r\n    background-color: white;\r\n    flex: 1;\r\n  }\r\n\r\n  .item {\r\n    height: 100px;\r\n  }\r\n</style>\r\n","import MiniProgramPage from 'W:/Workplace/2.小程序/lihai-app/pages/template/half-screen/half-screen.uvue'\nwx.createPage(MiniProgramPage)"],"names":["defineComponent","uni","_b","_a","_d","_c","_f","_e","_h","_g"],"mappings":"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"}