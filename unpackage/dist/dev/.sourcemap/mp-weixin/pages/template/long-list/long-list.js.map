{"version":3,"file":"long-list.js","sources":["pages/template/long-list/long-list.uvue","../../../Program Files/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXNcdGVtcGxhdGVcbG9uZy1saXN0XGxvbmctbGlzdC51dnVl"],"sourcesContent":["<template>\n  <scroll-view ref=\"pageScrollView\" class=\"page\" :bounces=\"false\"\n    @startnestedscroll=\"onStartNestedScroll\" @nestedprescroll=\"onNestedPreScroll\">\n    <view ref=\"header\" class=\"search-bar\">\n      <input placeholder=\"搜索...\" maxlength=\"-1\"/>\n    </view>\n    <view class=\"swiper-list\">\n      <scroll-view ref=\"tabScroll\" class=\"swiper-tabs\" direction=\"horizontal\" :show-scrollbar=\"false\">\n        <view class=\"flex-row\" style=\"align-self: flex-start;\">\n          <text ref=\"swipertab\" space=\"nbsp\" class=\"swiper-tabs-item\" :class=\"swiperIndex==index ? 'swiper-tabs-item-active' : ''\"\n            v-for=\"(item, index) in swiperList\" :key=\"index\" @click=\"onTabClick(index)\">\n            {{item.name}}\n          </text>\n        </view>\n        <view ref=\"indicator\" class=\"swiper-tabs-indicator\"></view>\n      </scroll-view>\n      <swiper ref=\"swiper\" class=\"swiper-view\" :current=\"swiperIndex\" @transition=\"onSwiperTransition\"\n        @animationfinish=\"onSwiperAnimationfinish\">\n        <swiper-item class=\"swiper-item\" v-for=\"(item, index) in swiperList\" :key=\"index\">\n          <long-page ref=\"longPageRef\" :type=\"item.type\" :preload=\"item.preload\"></long-page>\n        </swiper-item>\n      </swiper>\n    </view>\n  </scroll-view>\n</template>\n\n<script setup lang=\"uts\">\nimport longPage from './long-list-page.uvue';\n\ntype SwiperTabsItem = {\n  x : number,\n  w : number\n}\n\ntype SwiperViewItem = {\n  id : string, // 唯一字符串\n  type : string,\n  name : string,\n  preload : boolean,\n}\n\n/**\n * 根据权重在两个值之间执行线性插值.\n * @constructor\n * @param {number} value1 - 第一个值，该值应为下限.\n * @param {number} value2 - 第二个值，该值应为上限.\n * @param {number} amount - 应介于 0 和 1 之间，指示内插的权重.\n * @returns {number} 内插值\n */\nfunction lerpNumber(value1 : number, value2 : number, amount : number) : number {\n  return (value1 + (value2 - value1) * amount)\n}\n\n// 响应式变量\nconst swiperList = ref<SwiperViewItem[]>([\n  {\n    id: 'updated', // 唯一字符串\n    type: 'UpdatedDate',\n    name: '最新上架',\n    preload: true\n  },\n  {\n    id: 'free',\n    type: 'FreeHot',\n    name: '免费热榜',\n    preload: false\n  },\n  {\n    id: 'payment',\n    type: 'PaymentHot',\n    name: '付费热榜',\n    preload: false\n  },\n  {\n    id: 'hot',\n    type: 'HotList',\n    name: '热门总榜',\n    preload: false\n  }\n])\nconst swiperIndex = ref(0)\nconst pageScrollView = ref<UniScrollViewElement|null>(null)\nconst header = ref<UniElement|null>(null)\nconst tabScroll = ref<UniScrollViewElement|null>(null)\nconst indicator = ref<UniElement|null>(null)\nconst swiper = ref<UniSwiperElement|null>(null)\nconst swipertab = ref<UniTextElement[]|null>(null)\nconst longPageRef = ref<ComponentPublicInstance[]|null>(null)\nconst headerHeight = ref(0)\nconst animationFinishIndex = ref(0)\nconst swiperWidth = ref(0)\nconst swiperTabsRect = ref<SwiperTabsItem[]>([])\n\nfunction onStartNestedScroll() : boolean {\n  return true\n}\n\nfunction onNestedPreScroll(event : NestedPreScrollEvent) {\n  const deltaY = event.deltaY\n  const scrollTop = pageScrollView.value!.scrollTop\n\n  // 优先处理父容器滚动，父容器不能滚动时滚动子\n\n  if (deltaY > 0) {\n    // 向上滚动，如果父容器 header scrollTop < offsetHeight，先滚动父容器\n    if (scrollTop < headerHeight.value) {\n      const difference = headerHeight.value - scrollTop - deltaY\n      if (difference > 0) {\n        pageScrollView.value!.scrollBy(event.deltaX, deltaY)\n        event.consumed(event.deltaX, deltaY)\n      } else {\n        const top : number = deltaY + difference\n        event.consumed(event.deltaX, top.toFloat())\n        pageScrollView.value!.scrollBy(event.deltaX, top.toFloat())\n      }\n    }\n  } else if (deltaY < 0) {\n    // 向下滚动，如果父容器 scrollTop > 0，通知子被父容器消耗，然后滚动到 0\n    if (scrollTop > 0) {\n      event.consumed(event.deltaX, deltaY)\n      pageScrollView.value!.scrollBy(event.deltaX, deltaY)\n    }\n  }\n}\n\nfunction updateTabIndicator(current_index : number, move_to_index : number, percentage : number) {\n  const current_size = swiperTabsRect.value[current_index]\n  const move_to_size = swiperTabsRect.value[move_to_index]\n\n  // 计算指示线 左边距 和 宽度 在移动过程中的线性值\n  const indicator_line_x = lerpNumber(current_size.x, move_to_size.x, percentage)\n  const indicator_line_w = lerpNumber(current_size.w, move_to_size.w, percentage)\n\n  // 更新指示线\n\n\n\n\n\n  // TODO chrome windows系统 transform scaleX渲染bug\n  const x = indicator_line_x\n  indicator.value?.style?.setProperty('width', `${indicator_line_w}px`)\n  indicator.value?.style?.setProperty('transform', `translateX(${x}px)`)\n\n\n  // 滚动到水平中心位置\n  const scroll_x = x - swiperWidth.value / 2\n  // app 平台后续支持 scrollTo()\n\n\n\n\n  tabScroll.value!.scrollTo({\n    left: scroll_x\n  })\n\n}\n\nfunction initSwiperItemData(index : number) {\n  if (!swiperList.value[index].preload) {\n    swiperList.value[index].preload = true;\n    (longPageRef.value as ComponentPublicInstance[])[index].$callMethod('loadData', null)\n  }\n}\n\nfunction onSwiperTransition(e : SwiperTransitionEvent) {\n  // 微信 skyline 每项完成触发 Animationfinish，偏移值重置\n  // 微信 webview 全部完成触发 Animationfinish，偏移值累加\n  // 在滑动到下一个项的过程中，再次反向滑动，偏移值递减\n  // uni-app-x 和微信 webview 行为一致\n\n  const offset_x = e.detail.dx\n\n  // 计算当前索引并重置差异\n  const current_offset_x = offset_x % swiperWidth.value\n  const current_offset_i = offset_x / swiperWidth.value\n  const current_index = animationFinishIndex.value + parseInt(current_offset_i + '')\n\n  // 计算目标索引及边界检查\n  let move_to_index = current_index\n  if (current_offset_x > 0 && move_to_index < swiperList.value.length - 1) {\n    move_to_index += 1\n  } else if (current_offset_x < 0 && move_to_index > 0) {\n    move_to_index -= 1\n  }\n\n  // 计算偏移百分比\n  const percentage = Math.abs(current_offset_x) / swiperWidth.value\n\n  // 通知更新指示线\n  updateTabIndicator(current_index, move_to_index, percentage)\n\n  // 首次可见时初始化数据\n  initSwiperItemData(move_to_index)\n}\n\nasync function cacheTabItemsSize() {\n  swiperTabsRect.value.length = 0;\n  const tabs = swipertab.value as UniElement[]\n  for (let i = 0; i < tabs.length; i++) {\n    const element = tabs[i];\n\n    const rect = await element.getBoundingClientRectAsync()!\n    const x = rect.left\n    const w = rect.width\n\n\n\n\n\n    swiperTabsRect.value.push({\n      x,\n      w\n    } as SwiperTabsItem)\n  }\n}\n\nfunction setSwiperIndex(index : number, updateIndicator : boolean) {\n  if (swiperIndex.value === index) {\n    return\n  }\n\n  swiperIndex.value = index\n\n  initSwiperItemData(index)\n\n  if (updateIndicator) {\n    updateTabIndicator(index, index, 1)\n  }\n}\n\nfunction onTabClick(index : number) {\n  setSwiperIndex(index, false)\n}\n\nfunction onSwiperAnimationfinish(e : SwiperAnimationFinishEvent) {\n  setSwiperIndex(e.detail.current, true)\n  animationFinishIndex.value = e.detail.current\n}\n\nonReady(() => {\n  headerHeight.value = (header.value as UniElement).offsetHeight\n  swiper.value!.getBoundingClientRectAsync()!.then((res : DOMRect) : Promise<void> => {\n    swiperWidth.value = res.width\n    return cacheTabItemsSize()\n  }).then(() => {\n    updateTabIndicator(swiperIndex.value, swiperIndex.value, 1)\n  });\n})\n\nonPullDownRefresh(() => {\n  (longPageRef.value as ComponentPublicInstance[])[swiperIndex.value].$callMethod('refreshData', () => {\n    uni.stopPullDownRefresh()\n  })\n})\n\n</script>\n\n<style>\n  .flex-row {\n    flex-direction: row;\n  }\n\n  .page {\n    flex: 1;\n  }\n\n  .search-bar {\n    padding: 10px;\n  }\n\n  .swiper-list {\n    height: 100%;\n\n\n\n  }\n\n  .swiper-tabs {\n    background-color: #ffffff;\n    flex-direction: column;\n  }\n\n  .swiper-tabs-item {\n    color: #555;\n    font-size: 16px;\n    padding: 12px 25px;\n    white-space: nowrap;\n  }\n\n  .swiper-tabs-item-active {\n    color: #007AFF;\n  }\n\n  .swiper-tabs-indicator {\n    width: 1px;\n    height: 2px;\n    background-color: #007AFF;\n  }\n\n  .swiper-view {\n    flex: 1;\n  }\n\n  .swiper-item {\n    /* flex: 1; harmony 高度异常 */\n    height: 100%;\n  }\n</style>\n","import MiniProgramPage from 'W:/Workplace/2.小程序/lihai-app/pages/template/long-list/long-list.uvue'\nwx.createPage(MiniProgramPage)"],"names":["ref","onReady","onPullDownRefresh","uni","MiniProgramPage"],"mappings":"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"}