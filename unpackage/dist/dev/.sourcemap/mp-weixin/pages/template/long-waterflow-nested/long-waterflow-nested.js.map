{"version":3,"file":"long-waterflow-nested.js","sources":["pages/template/long-waterflow-nested/long-waterflow-nested.uvue","../../../Program Files/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXNcdGVtcGxhdGVcbG9uZy13YXRlcmZsb3ctbmVzdGVkXGxvbmctd2F0ZXJmbG93LW5lc3RlZC51dnVl"],"sourcesContent":["<template>\r\n  <scroll-view ref=\"pageScrollView\" class=\"page\" :bounces=\"false\" type=\"nested\">\r\n    <nested-scroll-header>\r\n      <swiper ref=\"header\" indicator-dots=\"true\" circular=\"true\">\r\n        <swiper-item v-for=\"i in 3\" :item-id=\"i\">\r\n          <image src=\"/static/shuijiao.jpg\" style=\"width:100% ;height: 240px;\"></image>\r\n          <text style=\"position: absolute;\">{{i}}</text>\r\n        </swiper-item>\r\n      </swiper>\r\n    </nested-scroll-header>\r\n    <nested-scroll-body style=\"height: 100%;\">\r\n      <view style=\"flex: 1;\">\r\n        <scroll-view ref=\"tabScrollView\" class=\"swiper-tabs\" direction=\"horizontal\" :show-scrollbar=\"false\">\r\n          <view class=\"flex-row\" style=\"align-self: flex-start;\">\r\n            <text ref=\"swipertab\" class=\"swiper-tabs-item\" :class=\"swiperIndex==index ? 'swiper-tabs-item-active' : ''\"\r\n              v-for=\"(item, index) in swiperList\" :key=\"index\" @click=\"onTabClick(index)\">\r\n              {{item.name}}\r\n            </text>\r\n          </view>\r\n          <view ref=\"indicatorNode\" class=\"swiper-tabs-indicator\"></view>\r\n        </scroll-view>\r\n        <swiper ref=\"swiper\" class=\"swiper-view\" :current=\"swiperIndex\" @transition=\"onSwiperTransition\"\r\n          @animationfinish=\"onSwiperAnimationfinish\">\r\n          <swiper-item class=\"swiper-item\" v-for=\"(item, index) in swiperList\" :key=\"index\">\r\n            <long-page ref=\"longPageRef\" :id=\"item.id\" :type=\"item.type\" :preload=\"item.preload\"></long-page>\r\n          </swiper-item>\r\n        </swiper>\r\n      </view>\r\n    </nested-scroll-body>\r\n  </scroll-view>\r\n</template>\r\n\r\n<script setup lang=\"uts\">\r\n  import longPage from './long-waterflow-page.uvue';\r\n\r\n  type SwiperTabsItem = {\r\n    x : number,\r\n    w : number\r\n  }\r\n\r\n  type SwiperViewItem = {\r\n    type : string,\r\n    name : string,\r\n    id : string,\r\n    preload : boolean,\r\n  }\r\n\r\n  /**\r\n   * 根据权重在两个值之间执行线性插值.\r\n   * @constructor\r\n   * @param {number} value1 - 第一个值，该值应为下限.\r\n   * @param {number} value2 - 第二个值，该值应为上限.\r\n   * @param {number} amount - 应介于 0 和 1 之间，指示内插的权重.\r\n   * @returns {number} 内插值\r\n   */\r\n  function lerpNumber(value1 : number, value2 : number, amount : number) : number {\r\n    return (value1 + (value2 - value1) * amount)\r\n  }\r\n\r\n  const swiperList = ref([\r\n    {\r\n      type: 'UpdatedDate',\r\n      name: '最新上架',\r\n      id: \"list-id-1\",\r\n      preload: true\r\n    } as SwiperViewItem,\r\n    {\r\n      type: 'FreeHot',\r\n      name: '免费热榜',\r\n      id: \"list-id-2\",\r\n      preload: false\r\n    } as SwiperViewItem,\r\n    {\r\n      type: 'PaymentHot',\r\n      name: '付费热榜',\r\n      id: \"list-id-3\",\r\n      preload: false\r\n    } as SwiperViewItem,\r\n    {\r\n      type: 'HotList',\r\n      name: '热门总榜',\r\n      id: \"list-id-4\",\r\n      preload: false\r\n    } as SwiperViewItem\r\n  ] as SwiperViewItem[]);\r\n  const swiperIndex = ref(0);\r\n  const pageScrollView = ref<UniScrollViewElement | null>(null);\r\n  const headerHeight = ref(0);\r\n  const animationFinishIndex = ref(0);\r\n  const tabScrollView = ref<UniScrollViewElement | null>(null);\r\n  const indicatorNode = ref<UniElement | null>(null);\r\n  const swiperWidth = ref(0);\r\n  const swiperTabsRect = ref([] as SwiperTabsItem[]);\r\n  const nestedScrollChildId = ref(\"\");\r\n  const header = ref<UniSwiperElement | null>(null);\r\n  const swipertab = ref<UniElement[]>([]);\r\n  const swiper = ref<UniSwiperElement | null>(null);\r\n  const longPageRef = ref<ComponentPublicInstance[]>([]);\r\n\r\n  function cacheTabItemsSize() {\r\n    swiperTabsRect.value.length = 0\r\n    swipertab.value.forEach((node) => {\r\n      swiperTabsRect.value.push({\r\n        x: node.offsetLeft,\r\n        w: node.offsetWidth\r\n      } as SwiperTabsItem)\r\n    })\r\n  }\r\n\r\n  function initSwiperItemData(index : number) {\r\n    if (!swiperList.value[index].preload) {\r\n      swiperList.value[index].preload = true;\r\n      longPageRef.value[index].$callMethod('loadData', null)\r\n    }\r\n    //swiper页面切换需要重新赋值嵌套滚动子元素的id\r\n    nestedScrollChildId.value = swiperList.value[index].id\r\n  }\r\n\r\n  function updateTabIndicator(current_index : number, move_to_index : number, percentage : number) {\r\n    const current_size = swiperTabsRect.value[current_index]\r\n    const move_to_size = swiperTabsRect.value[move_to_index]\r\n\r\n    // 计算指示线 左边距 和 宽度 在移动过程中的线性值\r\n    const indicator_line_x = lerpNumber(current_size.x, move_to_size.x, percentage)\r\n    const indicator_line_w = lerpNumber(current_size.w, move_to_size.w, percentage)\r\n\r\n    // 更新指示线\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n    // 滚动到水平中心位置\r\n    const scroll_x = x - swiperWidth.value / 2\r\n    if (tabScrollView.value !== null) {\r\n      tabScrollView.value!.scrollLeft = scroll_x\r\n    }\r\n  }\r\n\r\n  function setSwiperIndex(index : number, updateIndicator : boolean) {\r\n    if (swiperIndex.value === index) {\r\n      return\r\n    }\r\n\r\n    swiperIndex.value = index\r\n\r\n    initSwiperItemData(index)\r\n\r\n    if (updateIndicator) {\r\n      updateTabIndicator(index, index, 1)\r\n    }\r\n  }\r\n\r\n  function onTabClick(index : number) {\r\n    setSwiperIndex(index, false)\r\n  }\r\n\r\n  function onSwiperTransition(e : SwiperTransitionEvent) {\r\n    // 微信 skyline 每项完成触发 Animationfinish，偏移值重置\r\n    // 微信 webview 全部完成触发 Animationfinish，偏移值累加\r\n    // 在滑动到下一个项的过程中，再次反向滑动，偏移值递减\r\n    // uni-app-x 和微信 webview 行为一致\r\n\r\n    const offset_x = e.detail.dx\r\n\r\n    // 计算当前索引并重置差异\r\n    const current_offset_x = offset_x % swiperWidth.value\r\n    const current_offset_i = offset_x / swiperWidth.value\r\n    const current_index = animationFinishIndex.value + parseInt(current_offset_i + '')\r\n\r\n    // 计算目标索引及边界检查\r\n    let move_to_index = current_index\r\n    if (current_offset_x > 0 && move_to_index < swiperList.value.length - 1) {\r\n      move_to_index += 1\r\n    } else if (current_offset_x < 0 && move_to_index > 0) {\r\n      move_to_index -= 1\r\n    }\r\n\r\n    // 计算偏移百分比\r\n    const percentage = Math.abs(current_offset_x) / swiperWidth.value\r\n\r\n    // 通知更新指示线\r\n    if (current_index != move_to_index) {\r\n      updateTabIndicator(current_index, move_to_index, percentage)\r\n    }\r\n\r\n    // 首次可见时初始化数据\r\n    initSwiperItemData(move_to_index)\r\n  }\r\n\r\n  function onSwiperAnimationfinish(e : SwiperAnimationFinishEvent) {\r\n    setSwiperIndex(e.detail.current, true)\r\n    animationFinishIndex.value = e.detail.current\r\n  }\r\n\r\n  onReady(() => {\r\n    headerHeight.value = header.value!.offsetHeight\r\n    swiperWidth.value = swiper.value!.getBoundingClientRect().width\r\n    cacheTabItemsSize()\r\n    updateTabIndicator(swiperIndex.value, swiperIndex.value, 1)\r\n  });\r\n\r\n  onPullDownRefresh(() => {\r\n    longPageRef.value[swiperIndex.value].$callMethod('refreshData', () => {\r\n      uni.stopPullDownRefresh()\r\n    })\r\n  });\r\n</script>\r\n\r\n<style>\r\n  .flex-row {\r\n    flex-direction: row;\r\n  }\r\n\r\n  .page {\r\n    flex: 1;\r\n  }\r\n\r\n  .search-bar {\r\n    padding: 10px;\r\n  }\r\n\r\n  .swiper-list {\r\n    height: 100%;\r\n\r\n\r\n\r\n  }\r\n\r\n  .swiper-tabs {\r\n    background-color: #ffffff;\r\n    flex-direction: column;\r\n  }\r\n\r\n  .swiper-tabs-item {\r\n    color: #555;\r\n    font-size: 16px;\r\n    padding: 12px 25px;\r\n    white-space: nowrap;\r\n  }\r\n\r\n  .swiper-tabs-item-active {\r\n    color: #007AFF;\r\n  }\r\n\r\n  .swiper-tabs-indicator {\r\n    width: 1px;\r\n    height: 2px;\r\n    background-color: #007AFF;\r\n  }\r\n\r\n  .swiper-view {\r\n    flex: 1;\r\n  }\r\n\r\n  .swiper-item {\r\n    flex: 1;\r\n  }\r\n</style>\r\n","import MiniProgramPage from 'W:/Workplace/2.小程序/lihai-app/pages/template/long-waterflow-nested/long-waterflow-nested.uvue'\nwx.createPage(MiniProgramPage)"],"names":["ref","onReady","onPullDownRefresh","uni","MiniProgramPage"],"mappings":"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"}