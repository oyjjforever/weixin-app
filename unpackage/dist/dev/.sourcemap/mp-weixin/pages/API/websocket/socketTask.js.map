{"version":3,"file":"socketTask.js","sources":["pages/API/websocket/socketTask.uvue","../../../Program Files/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvQVBJL3dlYnNvY2tldC9zb2NrZXRUYXNrLnV2dWU"],"sourcesContent":["<template>\r\n  <page-head title=\"websocket通讯示例\"></page-head>\r\n  <view class=\"uni-padding-wrap\">\r\n    <view class=\"uni-btn-v\">\r\n      <text class=\"websocket-msg\">{{ showMsg }}</text>\r\n      <button class=\"uni-btn-v\" type=\"primary\" @click=\"connect\">\r\n        连接websocket服务\r\n      </button>\r\n      <button class=\"uni-btn-v\" v-show=\"connected\" type=\"primary\" @click=\"send\">\r\n        发送一条消息\r\n      </button>\n\t  <button class=\"uni-btn-v\" v-show=\"connected\" type=\"primary\" @click=\"sendArrayBuffer\">\n\t    发送一条ArrayBuffer消息,返回也是ArrayBuffer\n\t  </button>\r\n      <button class=\"uni-btn-v\" type=\"primary\" @click=\"close\">\r\n        断开websocket服务\r\n      </button>\r\n      <text class=\"websocket-tips\">发送消息后会收到一条服务器返回的消息（与发送的消息内容一致）</text>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script lang=\"uts\">\r\n  export default {\r\n    data() {\r\n      return {\r\n        connected: false,\r\n        connecting: false,\r\n        socketTask: null as SocketTask | null,\r\n        msg: '',\r\n        platform: '',\r\n        //自动化测试例专用\r\n        jest_result: 0,\r\n      }\r\n    },\r\n    computed: {\r\n      showMsg() : string {\r\n        if (this.connected) {\r\n          if (this.msg.length > 0) {\r\n            return '收到消息：' + this.msg\r\n          } else {\r\n            return '等待接收消息'\r\n          }\r\n        } else {\r\n          return '尚未连接'\r\n        }\r\n      },\r\n    },\r\n    onLoad() {\n      this.platform = uni.getDeviceInfo().platform as string\r\n    },\r\n    onUnload() {\r\n      uni.hideLoading()\r\n      let task = this.socketTask\r\n      if (task != null) {\r\n        task.close({\r\n          code: 1000,\r\n          reason: 'close reason from client',\r\n          success: (res : any) => {\r\n            uni.__f__('log','at pages/API/websocket/socketTask.uvue:60','uni.closeSocket success', res)\r\n          },\r\n          fail: (err : any) => {\r\n            uni.__f__('log','at pages/API/websocket/socketTask.uvue:63','uni.closeSocket fail', err)\r\n          },\r\n        } as CloseSocketOptions)\r\n      }\r\n    },\r\n    methods: {\r\n      connect() {\r\n        if (this.connected || this.connecting) {\r\n          uni.showModal({\r\n            content: '正在连接或者已经连接，请勿重复连接',\r\n            showCancel: false,\r\n          })\r\n          return\r\n        }\r\n        this.connecting = true\r\n        uni.showLoading({\r\n          title: '连接中...',\r\n        })\r\n        this.socketTask = uni.connectSocket({\r\n          url: 'wss://websocket.dcloud.net.cn',\r\n          success: (res : any) => {\r\n            // 这里是接口调用成功的回调，不是连接成功的回调，请注意\r\n            uni.__f__('log','at pages/API/websocket/socketTask.uvue:85','uni.connectSocket success', res)\r\n          },\r\n          fail: (err : any) => {\r\n            // 这里是接口调用失败的回调，不是连接失败的回调，请注意\r\n            uni.__f__('log','at pages/API/websocket/socketTask.uvue:89','uni.connectSocket fail', err)\r\n          },\r\n        })\r\n        this.socketTask?.onOpen((res : any) => {\r\n          this.connecting = false\r\n          this.connected = true\r\n          uni.hideLoading()\r\n          uni.showToast({\r\n            icon: 'none',\r\n            title: '连接成功',\r\n          })\r\n          uni.__f__('log','at pages/API/websocket/socketTask.uvue:100','onOpen', res)\r\n        })\r\n        this.socketTask?.onError((err : any) => {\r\n          this.connecting = false\r\n          this.connected = false\r\n          uni.hideLoading()\r\n          uni.showModal({\r\n            content: '连接失败，可能是websocket服务不可用，请稍后再试',\r\n            showCancel: false,\r\n          })\r\n          uni.__f__('log','at pages/API/websocket/socketTask.uvue:110','onError', err)\r\n        })\r\n        this.socketTask?.onMessage((res : OnSocketMessageCallbackResult) => {\n\t\t\tif(res.data instanceof ArrayBuffer){\n\t\t\t\tvar int8 = new Int8Array(res.data)\n\t\t\t\tthis.msg = int8.toString()\n\t\t\t\tuni.__f__('log','at pages/API/websocket/socketTask.uvue:116','onMessage', res)\n\t\t\t}else{\n\t\t\t\tthis.msg = res.data as string\n\t\t\t\tuni.__f__('log','at pages/API/websocket/socketTask.uvue:119','onMessage', res)\n\t\t\t}\r\n         \r\n        })\r\n        this.socketTask?.onClose((res : any) => {\r\n          this.connected = false\r\n          this.socketTask = null\r\n          this.msg = ''\r\n          uni.__f__('log','at pages/API/websocket/socketTask.uvue:127','onClose', res)\r\n        })\r\n      },\r\n      send() {\r\n        const data =\r\n          'from ' +\r\n          this.platform +\r\n          ' : ' +\r\n          parseInt(Math.random() * 10000 + '').toString()\r\n        this.socketTask?.send({\r\n          data,\r\n          success: (res : any) => {\r\n            uni.__f__('log','at pages/API/websocket/socketTask.uvue:139',res)\r\n          },\r\n          fail: (err : any) => {\r\n            uni.__f__('log','at pages/API/websocket/socketTask.uvue:142',err)\r\n          },\r\n        } as SendSocketMessageOptions)\r\n      },\n\t  sendArrayBuffer() {\n\t    const data = new ArrayBuffer(2)\n\t\tlet int8= new Int8Array(data)\n\t\tint8[0]=1\n\t\tint8[1]=2\n\t\t\n\t    this.socketTask?.send({\n\t      data,\n\t      success: (res : any) => {\n\t        uni.__f__('log','at pages/API/websocket/socketTask.uvue:155',res)\n\t      },\n\t      fail: (err : any) => {\n\t        uni.__f__('log','at pages/API/websocket/socketTask.uvue:158',err)\n\t      },\n\t    } as SendSocketMessageOptions)\n\t  },\r\n      close() {\r\n        this.socketTask?.close({\r\n          code: 1000,\r\n          reason: 'close reason from client',\r\n          success: (res : any) => {\r\n            uni.__f__('log','at pages/API/websocket/socketTask.uvue:167','uni.closeSocket success', res)\r\n          },\r\n          fail: (err : any) => {\r\n            uni.__f__('log','at pages/API/websocket/socketTask.uvue:170','uni.closeSocket fail', err)\r\n          },\r\n        } as CloseSocketOptions)\r\n      },\r\n      //自动化测试例专用\r\n      jest_connectSocket() {\r\n        this.socketTask = uni.connectSocket({\r\n          url: 'wss://websocket.dcloud.net.cn',\r\n          success: (_) => {\r\n            this.jest_result++\r\n          },\r\n          fail: (_) => {\r\n            this.jest_result = 0\r\n          },\r\n        })\r\n        this.socketTask?.onOpen((_) => {\r\n          const data =\r\n            'from ' +\r\n            this.platform +\r\n            ' : ' +\r\n            parseInt(Math.random() * 10000 + '').toString()\r\n          this.socketTask?.send({\r\n            data,\r\n            success: (_) => {\r\n              this.jest_result++\r\n            },\r\n            fail: (_) => {\r\n              this.jest_result = 0\r\n            },\r\n          } as SendSocketMessageOptions)\r\n        })\r\n        this.socketTask?.onError((_) => {\r\n          this.jest_result = 0;\r\n        })\r\n      }\r\n    },\r\n  }\r\n</script>\r\n\r\n<style>\r\n  .uni-btn-v {\r\n    padding: 5px 0;\r\n  }\r\n\r\n  .uni-btn-v {\r\n    margin: 10px 0;\r\n  }\r\n\r\n  .websocket-msg {\r\n    padding: 40px 0px;\r\n    text-align: center;\r\n    font-size: 14px;\r\n    line-height: 40px;\r\n    color: #666666;\r\n  }\r\n\r\n  .websocket-tips {\r\n    padding: 40px 0px;\r\n    text-align: center;\r\n    font-size: 14px;\r\n    line-height: 24px;\r\n    color: #666666;\r\n  }\r\n</style>\n","import MiniProgramPage from 'W:/Workplace/2.小程序/lihai-app/pages/API/websocket/socketTask.uvue'\nwx.createPage(MiniProgramPage)"],"names":["defineComponent","uni","_a","_"],"mappings":"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"}