{"version":3,"file":"websocket.js","sources":["pages/API/websocket/websocket.uvue","../../../Program Files/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvQVBJL3dlYnNvY2tldC93ZWJzb2NrZXQudXZ1ZQ"],"sourcesContent":["<template>\r\n  <page-head title=\"websocket通讯示例\"></page-head>\r\n  <view class=\"uni-padding-wrap\">\r\n    <view class=\"uni-btn-v\">\r\n      <text class=\"websocket-msg\">{{ showMsg }}</text>\r\n      <button class=\"uni-btn-v\" type=\"primary\" @click=\"connect\">\r\n        连接websocket服务\r\n      </button>\r\n      <button class=\"uni-btn-v\" v-show=\"connected\" type=\"primary\" @click=\"send\">\r\n        发送一条消息\r\n      </button>\r\n      <button class=\"uni-btn-v\" type=\"primary\" @click=\"close\">\r\n        断开websocket服务\r\n      </button>\r\n      <text class=\"websocket-tips\">发送消息后会收到一条服务器返回的消息（与发送的消息内容一致）</text>\r\n      <text class=\"websocket-tips\">web端和小程序端uni-push功能、app-android端和app-ios端的web-view组件日志回显、app-harmony端的日志回显会占用一个socket链接，此时使用全局的socket api会引发混乱。应使用socketTask操作websocket链接。</text>\n      <text class=\"websocket-tips\">小程序端日志回显功能也会占用一个socket链接，如果不希望使用此功能可以在HBuilderX控制台关闭日志回显。</text>\r\n      <button class=\"uni-btn-v\" type=\"primary\" @click=\"goSocketTask\">\r\n        跳转 socketTask 示例\r\n      </button>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script lang=\"uts\">\r\n  export default {\r\n    data() {\r\n      return {\r\n        connected: false,\r\n        connecting: false,\r\n        msg: '',\r\n        roomId: '',\r\n        platform: '',\r\n      }\r\n    },\r\n    computed: {\r\n      showMsg() : string {\r\n        if (this.connected) {\r\n          if (this.msg.length > 0) {\r\n            return '收到消息：' + this.msg\r\n          } else {\r\n            return '等待接收消息'\r\n          }\r\n        } else {\r\n          return '尚未连接'\r\n        }\r\n      },\r\n    },\r\n    onLoad() {\r\n      this.platform = uni.getDeviceInfo().platform as string\r\n    },\r\n    onUnload() {\r\n      uni.closeSocket({\r\n        code: 1000,\r\n        reason: 'close reason from client',\r\n        success: (res : any) => {\r\n          uni.__f__('log','at pages/API/websocket/websocket.uvue:57','uni.closeSocket success', res)\r\n        },\r\n        fail: (err : any) => {\r\n          uni.__f__('log','at pages/API/websocket/websocket.uvue:60','uni.closeSocket fail', err)\r\n        },\r\n      } as CloseSocketOptions)\r\n      uni.hideLoading()\r\n    },\r\n    methods: {\r\n      connect() {\r\n        if (this.connected || this.connecting) {\r\n          uni.showModal({\r\n            content: '正在连接或者已经连接，请勿重复连接',\r\n            showCancel: false,\r\n          })\r\n          return\r\n        }\r\n        this.connecting = true\r\n        uni.showLoading({\r\n          title: '连接中...',\r\n        })\r\n        uni.connectSocket({\r\n          url: 'wss://websocket.dcloud.net.cn',\r\n          header: null,\r\n          protocols: null,\r\n          success: (res : any) => {\r\n            // 这里是接口调用成功的回调，不是连接成功的回调，请注意\r\n            uni.__f__('log','at pages/API/websocket/websocket.uvue:84','uni.connectSocket success', res)\r\n          },\r\n          fail: (err : any) => {\r\n            // 这里是接口调用失败的回调，不是连接失败的回调，请注意\r\n            uni.__f__('log','at pages/API/websocket/websocket.uvue:88','uni.connectSocket fail', err)\r\n          },\r\n        })\r\n        uni.onSocketOpen((res) => {\r\n          this.connecting = false\r\n          this.connected = true\r\n          uni.hideLoading()\r\n\r\n          uni.showToast({\r\n            icon: 'none',\r\n            title: '连接成功',\r\n          })\r\n          uni.__f__('log','at pages/API/websocket/websocket.uvue:100','onOpen', res)\r\n        })\r\n        uni.onSocketError((err) => {\r\n          this.connecting = false\r\n          this.connected = false\r\n          uni.hideLoading()\r\n\r\n          uni.showModal({\r\n            content: '连接失败，可能是websocket服务不可用，请稍后再试',\r\n            showCancel: false,\r\n          })\r\n          uni.__f__('log','at pages/API/websocket/websocket.uvue:111','onError', err)\r\n        })\r\n        uni.onSocketMessage((res) => {\n\t\t   if(res.data instanceof ArrayBuffer){\n\t\t   \tvar int8 = new Int8Array(res.data)\n\t\t   \tthis.msg = int8.toString()\n\t\t   \tuni.__f__('log','at pages/API/websocket/websocket.uvue:117','onMessage', res)\n\t\t   }else{\n\t\t   \tthis.msg = res.data as string\n\t\t   \tuni.__f__('log','at pages/API/websocket/websocket.uvue:120','onMessage', res)\n\t\t   }\r\n        })\r\n        uni.onSocketClose((res) => {\r\n          this.connected = false\r\n          this.msg = ''\r\n          uni.__f__('log','at pages/API/websocket/websocket.uvue:126','onClose', res)\r\n        })\r\n      },\r\n      send() {\r\n        uni.sendSocketMessage({\r\n          data:\r\n            'from ' +\r\n            this.platform +\r\n            ' : ' +\r\n            parseInt((Math.random() * 10000).toString()).toString(),\r\n          success: (res : any) => {\r\n            uni.__f__('log','at pages/API/websocket/websocket.uvue:137',res)\r\n          },\r\n          fail: (err : any) => {\r\n            uni.__f__('log','at pages/API/websocket/websocket.uvue:140',err)\r\n          },\r\n        } as SendSocketMessageOptions)\r\n      },\r\n      close() {\r\n        uni.closeSocket({\r\n          code: 1000,\r\n          reason: 'close reason from client',\r\n          success: (res : any) => {\r\n            uni.__f__('log','at pages/API/websocket/websocket.uvue:149','uni.closeSocket success', res)\r\n          },\r\n          fail: (err : any) => {\r\n            uni.__f__('log','at pages/API/websocket/websocket.uvue:152','uni.closeSocket fail', err)\r\n          },\r\n        } as CloseSocketOptions)\r\n      },\r\n      goSocketTask() {\r\n        uni.navigateTo({\r\n          url: '/pages/API/websocket/socketTask',\r\n        })\r\n      }\r\n    },\r\n  }\r\n</script>\r\n\r\n<style>\r\n  .uni-btn-v {\r\n    padding: 5px 0;\r\n  }\r\n\r\n  .uni-btn-v {\r\n    margin: 10px 0;\r\n  }\r\n\r\n  .websocket-msg {\r\n    padding: 40px 0px;\r\n    text-align: center;\r\n    font-size: 14px;\r\n    line-height: 40px;\r\n    color: #666666;\r\n  }\r\n\r\n  .websocket-tips {\r\n    padding: 10px 0px;\r\n    text-align: center;\r\n    font-size: 14px;\r\n    line-height: 24px;\r\n    color: #666666;\r\n  }\r\n</style>\n","import MiniProgramPage from 'W:/Workplace/2.小程序/lihai-app/pages/API/websocket/websocket.uvue'\nwx.createPage(MiniProgramPage)"],"names":["defineComponent","uni"],"mappings":";;AAyBE,MAAA,YAAeA,8BAAA;AAAA,EACb,OAAI;AACF,WAAO;AAAA,MACL,WAAW;AAAA,MACX,YAAY;AAAA,MACZ,KAAK;AAAA,MACL,QAAQ;AAAA,MACR,UAAU;AAAA;EAEb;AAAA,EACD,UAAU;AAAA,IACR,UAAO;AACL,UAAI,KAAK,WAAW;AAClB,YAAI,KAAK,IAAI,SAAS,GAAG;AACvB,iBAAO,UAAU,KAAK;AAAA,QACtB,OAAK;AACL,iBAAO;AAAA,QACT;AAAA,MACA,OAAK;AACL,eAAO;AAAA,MACT;AAAA,IACD;AAAA,EACF;AAAA,EACD,SAAM;AACJ,SAAK,WAAWC,cAAAA,MAAI,cAAa,EAAG;AAAA,EACrC;AAAA,EACD,WAAQ;AACNA,kBAAAA,MAAI,YAAY;AAAA,MACd,MAAM;AAAA,MACN,QAAQ;AAAA,MACR,SAAS,CAAC,MAAS,SAAA;AACjBA,sBAAG,MAAC,MAAM,OAAM,4CAA2C,2BAA2B,GAAG;AAAA,MAC1F;AAAA,MACD,MAAM,CAAC,MAAS,SAAA;AACdA,sBAAG,MAAC,MAAM,OAAM,4CAA2C,wBAAwB,GAAG;AAAA,MACvF;AAAA,IACoB,CAAA;AACvBA,kBAAG,MAAC,YAAW;AAAA,EAChB;AAAA,EACD,SAAS;AAAA,IACP,UAAO;AACL,UAAI,KAAK,aAAa,KAAK,YAAY;AACrCA,4BAAI,UAAU,IAAA,cAAA;AAAA,UACZ,SAAS;AAAA,UACT,YAAY;AAAA,QACb,CAAA,CAAA;AACD,eAAK;AAAA,MACP;AACA,WAAK,aAAa;AAClBA,oBAAAA,MAAI,YAAY;AAAA,QACd,OAAO;AAAA,MACR,CAAA;AACDA,oBAAAA,MAAI,cAAc;AAAA,QAChB,KAAK;AAAA,QACL,QAAQ;AAAA,QACR,WAAW;AAAA,QACX,SAAS,CAAC,MAAS,SAAA;AAEjBA,wBAAG,MAAC,MAAM,OAAM,4CAA2C,6BAA6B,GAAG;AAAA,QAC5F;AAAA,QACD,MAAM,CAAC,MAAS,SAAA;AAEdA,wBAAG,MAAC,MAAM,OAAM,4CAA2C,0BAA0B,GAAG;AAAA,QACzF;AAAA,MACF,CAAA;AACDA,0BAAI,aAAa,CAAC,QAAG;AACnB,aAAK,aAAa;AAClB,aAAK,YAAY;AACjBA,sBAAG,MAAC,YAAW;AAEfA,sBAAAA,MAAI,UAAU;AAAA,UACZ,MAAM;AAAA,UACN,OAAO;AAAA,QACR,CAAA;AACDA,sBAAG,MAAC,MAAM,OAAM,6CAA4C,UAAU,GAAG;AAAA,MAC3E,CAAC;AACDA,0BAAI,cAAc,CAAC,QAAG;AACpB,aAAK,aAAa;AAClB,aAAK,YAAY;AACjBA,sBAAG,MAAC,YAAW;AAEfA,4BAAI,UAAU,IAAA,cAAA;AAAA,UACZ,SAAS;AAAA,UACT,YAAY;AAAA,QACb,CAAA,CAAA;AACDA,sBAAG,MAAC,MAAM,OAAM,6CAA4C,WAAW,GAAG;AAAA,MAC5E,CAAC;AACDA,0BAAI,gBAAgB,CAAC,QAAG;AAC3B,YAAA,IAAA,aAAG,IAAI,MAAgB,WAAW,GAAC;AAClC,cAAI,OAAO,IAAI,UAAU,IAAI,IAAI;AACjC,eAAK,MAAM,KAAK;AAChBA,wBAAG,MAAC,MAAM,OAAM,6CAA4C,aAAa,GAAG;AAAA,QAC5E,OAAI;AACJ,eAAK,MAAM,IAAI;AACfA,wBAAG,MAAC,MAAM,OAAM,6CAA4C,aAAa,GAAG;AAAA,QAC7E;AAAA,MACG,CAAC;AACDA,0BAAI,cAAc,CAAC,QAAG;AACpB,aAAK,YAAY;AACjB,aAAK,MAAM;AACXA,sBAAG,MAAC,MAAM,OAAM,6CAA4C,WAAW,GAAG;AAAA,MAC5E,CAAC;AAAA,IACF;AAAA,IACD,OAAI;AACFA,oBAAAA,MAAI,kBAAkB;AAAA,QACpB,MACE,UACA,KAAK,WACL,QACA,UAAU,KAAK,OAAM,IAAK,KAAO,SAAQ,CAAE,EAAE,SAAU;AAAA,QACzD,SAAS,CAAC,MAAS,SAAA;AACjBA,wBAAAA,MAAI,MAAM,OAAM,6CAA4C,GAAG;AAAA,QAChE;AAAA,QACD,MAAM,CAAC,MAAS,SAAA;AACdA,wBAAAA,MAAI,MAAM,OAAM,6CAA4C,GAAG;AAAA,QAChE;AAAA,MAC0B,CAAA;AAAA,IAC9B;AAAA,IACD,QAAK;AACHA,oBAAAA,MAAI,YAAY;AAAA,QACd,MAAM;AAAA,QACN,QAAQ;AAAA,QACR,SAAS,CAAC,MAAS,SAAA;AACjBA,wBAAG,MAAC,MAAM,OAAM,6CAA4C,2BAA2B,GAAG;AAAA,QAC3F;AAAA,QACD,MAAM,CAAC,MAAS,SAAA;AACdA,wBAAG,MAAC,MAAM,OAAM,6CAA4C,wBAAwB,GAAG;AAAA,QACxF;AAAA,MACoB,CAAA;AAAA,IACxB;AAAA,IACD,eAAY;AACVA,oBAAAA,MAAI,WAAW;AAAA,QACb,KAAK;AAAA,MACN,CAAA;AAAA,IACH;AAAA,EACD;CACH;;;;;;;;;;;;;;;;;;;;;;;AChKF,GAAG,WAAW,eAAe;"}